version: "3.9"

services:

  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: appbot
      POSTGRES_PASSWORD: appbot
      POSTGRES_DB: appbot
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  clickhouse:
    image: clickhouse/clickhouse-server:23
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse

  ingestion-api:
    image: python:3.10-slim
    container_name: appbot_ingestion
    volumes:
      - ./ingestion:/app
    working_dir: /app
    command: >
      sh -c "
      pip install -r requirements.txt &&
      uvicorn main:app --host 0.0.0.0 --port 8000
      "
    ports:
      - "8000:8000"
    depends_on:
      - postgres

  api:
    image: python:3.10-slim
    container_name: appbot_api
    volumes:
      - ./api:/app
    working_dir: /app
    command: >
      sh -c "
      pip install fastapi uvicorn &&
      uvicorn main:app --host 0.0.0.0 --port 9001
      "
    ports:
      - "9001:9001"
    depends_on:
      - postgres
      - clickhouse

volumes:
  postgres_data:
  clickhouse_data:
